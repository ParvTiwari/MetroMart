<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sales | MetroMart</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <%- include('partials/header') %>

  <main class="container py-4">
    <h1 class="page-title">üßæ Sales Management</h1>

    <!-- üîî Flash messages -->
    <% if (message && message.length > 0) { %>
      <script>
        Swal.fire({
          icon: 'success',
          title: '<%= message[0] %>',
          showConfirmButton: false,
          timer: 2000
        });
      </script>
    <% } %>

    <% if (error && error.length > 0) { %>
      <script>
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: '<%= error[0] %>',
        });
      </script>
    <% } %>

    <section class="form-section">
      <h2 class="section-title">‚ûï Add New Sale</h2>
      <br>

      <form id="salesForm" action="/sales" method="POST" onsubmit="return validateDiscount()">
        <div class="row mb-3">
          <div class="col-md-3">
            <label>Customer</label>
            <select name="customer_id" class="form-select">
              <option value="">Select Customer</option>
              <% customers.forEach(c => { %>
                <option value="<%= c.customer_id %>"><%= c.customer_name %></option>
              <% }) %>
            </select>
          </div>

          <div class="col-md-3">
            <label>Salesperson</label>
            <select name="emp_id" class="form-select" required>
              <option value="">Select Employee</option>
              <% employees.forEach(e => { %>
                <option value="<%= e.emp_id %>"><%= e.emp_name %></option>
              <% }) %>
            </select>
          </div>

          <div class="col-md-3">
            <label>Discount (‚Çπ)</label>
            <input type="number" name="discount_applied" id="discount" value="0" class="form-control">
          </div>

          <div class="col-md-3">
            <label>Tax (‚Çπ)</label>
            <input type="number" name="tax_amount" value="0" class="form-control">
          </div>
        </div>

        <h5>Add Products</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <select id="productSelect" class="form-select">
              <option value="">Select Product</option>
              <% products.forEach(p => { %>
                <option value="<%= p.product_code %>" data-price="<%= p.price %>">
                  <%= p.product_name %> ‚Äî ‚Çπ<%= p.price %>
                </option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-2">
            <input type="number" id="qty" class="form-control" placeholder="Qty" min="1">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-primary w-100" onclick="addItem()">+ Add</button>
          </div>
        </div>

        <table class="table table-bordered table-striped">
          <thead class="table-primary">
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price (‚Çπ)</th>
              <th>Total (‚Çπ)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="itemsTable"></tbody>
        </table>

        <input type="hidden" name="items" id="itemsInput">
        <button type="submit" class="btn btn-success">üíæ Save Sale</button>
      </form>
    </section>

    <hr>

    <section>
      <h2 class="section-title">üìã Sales List</h2>
      <table class="table table-hover table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Invoice #</th>
            <th>Customer</th>
            <th>Employee</th>
            <th>Date</th>
            <th>Subtotal</th>
            <th>Discount</th>
            <th>Tax</th>
            <th>Final Amount</th>
          </tr>
        </thead>
        <tbody>
          <% sales.forEach(s => { %>
            <tr>
              <td><%= s.invoice_num %></td>
              <td><%= s.customer_name || 'Guest' %></td>
              <td><%= s.emp_name %></td>
              <td><%= new Date(s.invoice_timestamp).toLocaleString() %></td>
              <td>‚Çπ<%= s.sub_total %></td>
              <td>‚Çπ<%= s.discount_applied %></td>
              <td>‚Çπ<%= s.tax_amount %></td>
              <td><strong>‚Çπ<%= s.final_amount %></strong></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </section>
  </main>

  <%- include('partials/footer') %>

  <script>
    let items = [];

    function addItem() {
      const select = document.getElementById("productSelect");
      const qty = parseInt(document.getElementById("qty").value);
      const price = parseFloat(select.options[select.selectedIndex].getAttribute("data-price"));
      const name = select.options[select.selectedIndex].text;

      if (!select.value || !qty || qty <= 0) {
        Swal.fire("‚ö† Please select a product and enter valid quantity.");
        return;
      }

      const total = qty * price;
      items.push({ product_code: select.value, quantity: qty, selling_price: price });

      const table = document.getElementById("itemsTable");
      const row = `<tr>
          <td>${name}</td>
          <td>${qty}</td>
          <td>‚Çπ${price}</td>
          <td>‚Çπ${total}</td>
          <td><button class="btn btn-sm btn-danger" onclick="removeItem('${select.value}')">üóë</button></td>
        </tr>`;
      table.insertAdjacentHTML("beforeend", row);

      document.getElementById("itemsInput").value = JSON.stringify(items);
    }

    function removeItem(code) {
      items = items.filter(i => i.product_code !== code);
      document.getElementById("itemsInput").value = JSON.stringify(items);
      document.getElementById("itemsTable").innerHTML = "";
      items.forEach(i => addItem(i));
    }

    function validateDiscount() {
      const discount = parseFloat(document.getElementById("discount").value);
      const subtotal = items.reduce((sum, i) => sum + i.quantity * i.selling_price, 0);
      if (discount > subtotal || (subtotal > 0 && (discount / subtotal) * 100 > 100)) {
        Swal.fire("‚ùå Discount cannot exceed 100% of total!");
        return false;
      }
      return true;
    }
  </script>
</body>
</html>
